# 主状态机功能描述

## 接口和变量描述

​	主状态机接收6个输入，分别为时钟信号clk2(1Hz)， clk3(500Hz)，使能信号enable，5比特位按钮button，30比特位键盘输入key，键盘输入结束信号finish。

​	输出16个信号，分别为显示模式displayMode，剩余车位left，起始价格st，时价per，vid用户ID{id1,id0}，vip余额{remain1,remain0}，七段数码显示管{x7,x6,x5,x4,x3,x2,x1,x0}。

​	状态机现态和次态使用6位寄存器储存，并且将每个状态设为参数，便于理解。

​	以下为部分状态

```verilog
parameter Idle = 6'b000001;
parameter InputVip = 6'b000010;
parameter Register = 6'b000011;
parameter VipRecharge = 6'b000100;
parameter VipInterface = 6'b000101;
```

​	id, vipId, vipCode, vipBalance, timeStart都为32位寄存器，最多储存4位用户信息，即每位用户占据8位。

​	start, vipStart, start_, hour为收费标准，都为8位寄存器，分别代表起步价，vip起步价，起步价缓存(用于计算账单)，时价。

​	Income是8位寄存器，用于储存总收入，counter是16位寄存器，用于倒计时。

​	flag和vipFlag都为5位寄存器，用于标记当前用户信息所处位置。

​	stallAble是4位寄存器，用于判断车位是否可用(管理员设置车位数量)。

​	clock为8为寄存器，用于储存现在时间，随clk2自增，即每秒+1。duration为8位寄存器，用于储存当前用户停留时间，方便计算账单。

​	change为8位寄存器，用于储存找零。

​	isVip是1位寄存器，用于在付款界面判断是否为vip用户。

​	codeCache是8位寄存器，用于在Vip用户重置密码时判断前后两次是否一致。

​	bill为8位wire，即账单，是子模块CountMoney的输出。

## 子模块

**核心代码**

```verilog
module CountMoney (
    duration, start, hour,bill
);
input[7:0] duration, start, hour;
output [7:0] bill;
assign bill = start + ((duration/ 'd10) * hour);
endmodule
```

**模块例化**

```verilog
CountMoney coun(duration,start_,hour,bill);
```

​	

根据输入计算账单,duration为停车时间，start为起步价，hour为时价， bill为账单。

## 状态机计时

**核心代码**

```verilog
always @(posedge clk2 or negedge enable) begin
    if (!enable) begin
        clock = 8'b0;
    end
    else begin
        clock = clock + 1;
    end
end
```

​	使能信号enable为1时，clock随clk2自增。

## 状态更新

**核心代码**

```verilog
always @(posedge clk3 or negedge enable) begin
    if (!enable)begin
        currentState <= Idle;
    end
    else begin
        currentState <= nextState;
    end
end
```

​		使能信号enable为1时，将nextState的值赋给currentState。

## 状态切换

**核心代码**

```verilog
always @(*) begin
    begin
        case (currentState)
            Idle: begin//闲置状态
                case (button)//按钮触发
                    buttonLeft:
                        if (left != 3'b0) begin
                            nextState = SelectSec;//选区
                        end
                        else begin
                            nextState = ShowNoStall;//显示车位不够
                        end
                    buttonRight:
                        nextState = InputId;//离场
                    buttonUp:
                        nextState = InputVip;//vip登陆
                    buttonDown:
                        nextState = AdminInterface;//管理员界面
                    default:
                        nextState = Idle;
                endcase
            end
          //more State......
        endcase
    end
end
```

​	主状态机为三段式设计，状态切换部分敏感于*，根据不同的输入和条件判断下一个状态。

## 各状态输出/变量更改

```verilog
always @(posedge clk3 or negedge enable) begin
    if (!enable) begin
        displayMode <= 'b0;
        id <= 32'b0;
        vipId <= 32'b0;
        vipCode <= 32'b0;
        vipBalance <= 32'b0;
        timeStart <= 32'b0;
        timeDuration <= 4'b0;
        start <= 8'b00000001;
        vipStart <= 8'b00000001;
        start_ <= 8'b00000001;
        hour <= 8'b00000001;
        Income <= 8'b0;
        counter <= 16'b0;
        flag <= 5'b0;
        vipFlag <= 5'b0;
        clock <= 8'b0;
        duration <= 8'b0;
        change <= 8'b0;
        isVip <= 1'b0;
        codeCache <= 8'b0;
    end
    else begin
        case (currentState)
            Idle: begin//闲置状态
                displayMode <= 'd1;
                st <= start;
                per <= hour;
            end
          InputMoney: begin
                displayMode <= 3;
                x0 <= bill[5:0];
                x1 <= 6'b111_111;
                x2 <= 6'b111_111;
                x3 <= 6'b111_111;
                x4 <= 'd21;
                x5 <= 'd21;
                x6 <= 'd18;
                x7 <= 'd11;
            if (counter == delay) begin//倒计时
                    counter <= 16'b0;
                end
                else begin
                    counter <= counter + 1;
                    duration <= clock - timeStart[flag +: 8];
                    if (button == buttonLeft) begin
                        if(!isVip)begin
                            start_ <= start;
                            if ({key[9:6],key[3:0]} >= bill) begin//够钱
                                id[flag +: 8] <= 8'b0;
                                Income <= Income + bill;
                                change <= {key[9:6],key[3:0]} - bill;
                            end
                        end
                        else begin
                            start_ <= vipStart;
                            if ({key[9:6],key[3:0]} >= bill - vipBalance[vipFlag +: 8]) begin//够钱
                                id[flag +: 8] <= 8'b0;
                                vipBalance[vipFlag +: 8] <= 8'b0;
                                Income <= Income + bill;
                                change <= {key[9:6],key[3:0]} - bill;
                            end
                        end
                    end
                end
            end
          //more State......
        endcase
    end
end
```

​	更改变量和输出的always块敏感于clk3上升沿和使能信号下降沿，根据不同的状态和输入更改输出或修改变量值。其中实现了用户信息和vip信息的存储和更改，入场时ID的分配，不同状态的七段数码管显示，以及各种变量的修改。